<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬°Factorizaci√≥n Prima! - Conceptos Num√©ricos</title>
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="../../css/core.css">
    <link rel="stylesheet" href="../../css/components.css">
    
    <style>
        /* Module-specific factorization styles */
        .glossary-item {
            background: white;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .glossary-item h3 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .symbol-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .symbol-display {
            font-size: 3rem;
            color: #f093fb;
            margin-bottom: 0.5rem;
        }
        
        .symbols-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }
        
        .prime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin: 30px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .prime-number {
            background: rgba(78, 205, 196, 0.3);
            border: 3px solid var(--primary-color);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            transition: transform 0.3s ease;
        }
        
        .prime-number:hover {
            transform: scale(1.1);
        }
        
        .factor-tree {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 30px auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-width: 600px;
        }
        
        .tree-node {
            text-align: center;
            margin: 20px 0;
        }
        
        .tree-value {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            line-height: 60px;
            font-size: 1.5em;
            font-weight: bold;
            margin: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .tree-prime {
            background: var(--accent-color);
        }
        
        .tree-branch {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin: 10px 0;
        }
        
        .factor-list {
            background: rgba(78, 205, 196, 0.2);
            border-left: 5px solid var(--primary-color);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .factor-list h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .factor-display {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-color);
            margin: 15px 0;
        }
        
        .composition-box {
            background: white;
            border: 3px solid var(--primary-color);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .composition-equation {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 20px 0;
        }
        
        .times-sign {
            color: var(--accent-color);
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="header-container"></div>
        <div id="tabs-container"></div>

        <!-- GLOSARIO TAB -->
        <div id="glosario" class="content tab-content active">
            <h2 class="section-title">üìñ Glosario de Factorizaci√≥n Prima</h2>
            
            <div class="explanation">
                <p>Aprende los t√©rminos clave relacionados con la factorizaci√≥n prima:</p>
            </div>

            <div class="glossary-item">
                <h3>üî¢ N√∫mero Primo</h3>
                <p><strong>Definici√≥n:</strong> Un n√∫mero mayor que 1 que solo se puede dividir exactamente por 1 y por s√≠ mismo.</p>
                <p><strong>Ejemplo:</strong> 2, 3, 5, 7, 11, 13, 17, 19, 23... (El 2 es el √∫nico primo par)</p>
            </div>

            <div class="glossary-item">
                <h3>üå≤ Factorizaci√≥n Prima</h3>
                <p><strong>Definici√≥n:</strong> El proceso de descomponer un n√∫mero en el producto de sus factores primos.</p>
                <p><strong>Ejemplo:</strong> 12 = 2 √ó 2 √ó 3 (o 2¬≤ √ó 3)</p>
            </div>

            <div class="glossary-item">
                <h3>üì¶ Factor</h3>
                <p><strong>Definici√≥n:</strong> Un n√∫mero que divide exactamente a otro n√∫mero sin dejar residuo.</p>
                <p><strong>Ejemplo:</strong> Los factores de 12 son: 1, 2, 3, 4, 6, 12</p>
            </div>

            <div class="glossary-item">
                <h3>üîó N√∫mero Compuesto</h3>
                <p><strong>Definici√≥n:</strong> Un n√∫mero mayor que 1 que NO es primo (tiene m√°s de dos divisores).</p>
                <p><strong>Ejemplo:</strong> 4, 6, 8, 9, 10, 12... (todos tienen factores adem√°s de 1 y ellos mismos)</p>
            </div>

            <div class="glossary-item">
                <h3>‚ûó Divisor</h3>
                <p><strong>Definici√≥n:</strong> Un n√∫mero que divide exactamente a otro n√∫mero.</p>
                <p><strong>Ejemplo:</strong> 3 es divisor de 15 porque 15 √∑ 3 = 5 (sin residuo)</p>
            </div>
        </div>

        <!-- S√çMBOLOS TAB -->
        <div id="simbolos" class="content tab-content">
            <h2 class="section-title">üî£ S√≠mbolos en Factorizaci√≥n Prima</h2>
            
            <div class="explanation">
                <p>Conoce los s√≠mbolos matem√°ticos usados en factorizaci√≥n prima:</p>
            </div>

            <div class="symbols-grid">
                <div class="symbol-card">
                    <div class="symbol-display">√ó</div>
                    <h3>Multiplicaci√≥n</h3>
                    <p>Indica que los factores se multiplican</p>
                    <p class="example">Ejemplo: 2 √ó 2 √ó 3 = 12</p>
                </div>

                <div class="symbol-card">
                    <div class="symbol-display">=</div>
                    <h3>Igual</h3>
                    <p>Muestra que ambos lados son equivalentes</p>
                    <p class="example">Ejemplo: 18 = 2 √ó 3 √ó 3</p>
                </div>

                <div class="symbol-card">
                    <div class="symbol-display">¬≤</div>
                    <h3>Exponente (al cuadrado)</h3>
                    <p>Indica que el factor se repite 2 veces</p>
                    <p class="example">Ejemplo: 2¬≤ = 2 √ó 2 = 4</p>
                </div>

                <div class="symbol-card">
                    <div class="symbol-display">¬≥</div>
                    <h3>Exponente (al cubo)</h3>
                    <p>Indica que el factor se repite 3 veces</p>
                    <p class="example">Ejemplo: 2¬≥ = 2 √ó 2 √ó 2 = 8</p>
                </div>

                <div class="symbol-card">
                    <div class="symbol-display">P</div>
                    <h3>N√∫mero Primo (P)</h3>
                    <p>Abreviatura para indicar un n√∫mero primo</p>
                    <p class="example">Ejemplo: 7 es P, 8 NO es P</p>
                </div>
            </div>
        </div>

        <!-- INTRODUCCI√ìN TAB -->
        <div id="introduccion" class="content tab-content">
            <h2 class="section-title">üåç Factorizaci√≥n Prima en el Mundo Real</h2>
            
            <div class="explanation">
                <h3>¬øPor qu√© es importante la factorizaci√≥n prima?</h3>
                <p>La factorizaci√≥n prima tiene aplicaciones pr√°cticas en muchas √°reas:</p>
            </div>

            <div class="fun-facts">
                <h3>üíº En Criptograf√≠a y Seguridad</h3>
                <p>Los n√∫meros primos muy grandes son la base de la seguridad en internet. Los bancos y sitios web seguros usan factorizaci√≥n prima para proteger tus contrase√±as y datos personales.</p>
                <p class="example"><strong>Aplicaci√≥n:</strong> El sistema RSA usa productos de n√∫meros primos grandes que son muy dif√≠ciles de factorizar.</p>
            </div>

            <div class="fun-facts">
                <h3>üîß En Ingenier√≠a</h3>
                <p>Los engranajes y ruedas dentadas usan n√∫meros primos para evitar desgaste uniforme. Si dos ruedas tienen n√∫meros de dientes que son primos entre s√≠, duran m√°s tiempo.</p>
                <p class="example"><strong>Aplicaci√≥n:</strong> Una rueda de 13 dientes con otra de 17 dientes minimiza el desgaste.</p>
            </div>

            <div class="fun-facts">
                <h3>ÔøΩÔøΩ En M√∫sica</h3>
                <p>Las frecuencias de las notas musicales se basan en razones de n√∫meros primos para crear armon√≠a.</p>
                <p class="example"><strong>Aplicaci√≥n:</strong> Las proporciones 2:3 (quinta perfecta) y 3:4 (cuarta perfecta) usan n√∫meros primos.</p>
            </div>

            <div class="fun-facts">
                <h3>üíª En Programaci√≥n</h3>
                <p>Los algoritmos de b√∫squeda y las tablas hash usan n√∫meros primos para distribuir datos eficientemente y evitar colisiones.</p>
                <p class="example"><strong>Aplicaci√≥n:</strong> Los tama√±os de tablas hash suelen ser n√∫meros primos.</p>
            </div>

            <div class="fun-facts">
                <h3>üßÆ En Matem√°ticas</h3>
                <p>La factorizaci√≥n prima es fundamental para encontrar el M√°ximo Com√∫n Divisor (MCD) y el M√≠nimo Com√∫n M√∫ltiplo (MCM) de dos n√∫meros.</p>
                <p class="example"><strong>Aplicaci√≥n:</strong> Simplificar fracciones y resolver problemas de proporciones.</p>
            </div>
        </div>

        <!-- TEOR√çA TAB -->
        <div id="teoria" class="content tab-content">
            <h2 class="section-title">üìö Teor√≠a y Pr√°ctica de Factorizaci√≥n Prima</h2>
            
            <div class="explanation">
                <h3>¬øQu√© es la Factorizaci√≥n Prima?</h3>
                <p>La factorizaci√≥n prima es descomponer un n√∫mero en sus factores primos. Es como encontrar los "bloques b√°sicos" que forman un n√∫mero.</p>
            </div>

            <!-- Prime Numbers Display -->
            <h3 class="header-with-color">‚≠ê N√∫meros Primos del 1 al 100</h3>
            <div class="explanation">
                <p>Los primeros 25 n√∫meros primos:</p>
            </div>

            <div class="prime-grid">
                <div class="prime-number">2</div>
                <div class="prime-number">3</div>
                <div class="prime-number">5</div>
                <div class="prime-number">7</div>
                <div class="prime-number">11</div>
                <div class="prime-number">13</div>
                <div class="prime-number">17</div>
                <div class="prime-number">19</div>
                <div class="prime-number">23</div>
                <div class="prime-number">29</div>
                <div class="prime-number">31</div>
                <div class="prime-number">37</div>
                <div class="prime-number">41</div>
                <div class="prime-number">43</div>
                <div class="prime-number">47</div>
                <div class="prime-number">53</div>
                <div class="prime-number">59</div>
                <div class="prime-number">61</div>
                <div class="prime-number">67</div>
                <div class="prime-number">71</div>
                <div class="prime-number">73</div>
                <div class="prime-number">79</div>
                <div class="prime-number">83</div>
                <div class="prime-number">89</div>
                <div class="prime-number">97</div>
            </div>

            <!-- Test if Prime -->
            <h3 class="header-with-color margin-top-30">üîç Calculadora: ¬øEs Primo?</h3>
            <div class="input-section">
                <div class="input-group">
                    <label for="prime-test-input">Escribe un n√∫mero:</label>
                    <input type="number" id="prime-test-input" placeholder="Ej: 17" min="2" max="1000">
                </div>
                <button class="calc-button" onclick="testPrime()">Comprobar si es Primo</button>
            </div>
            <div id="prime-test-result" class="result-container"></div>

            <!-- Factorize Number -->
            <h3 class="header-with-color margin-top-30">üå≤ Calculadora: Factorizar un N√∫mero</h3>
            <div class="input-section">
                <div class="input-group">
                    <label for="factor-input">N√∫mero (2-1000):</label>
                    <input type="number" id="factor-input" placeholder="Ej: 24" min="2" max="1000">
                </div>
                <button class="calc-button" onclick="factorizeNumber()">Factorizar</button>
            </div>
            <div id="factor-result" class="result-container"></div>

            <div class="fun-facts margin-top-30">
                <h3>üìù Pasos para Factorizar:</h3>
                <ol>
                    <li>Empieza probando con 2 (el primo m√°s peque√±o)</li>
                    <li>Si el n√∫mero es divisible, div√≠delo</li>
                    <li>Contin√∫a con el resultado hasta que sea primo</li>
                    <li>Si 2 no funciona, prueba con 3, luego 5, 7, etc.</li>
                </ol>
            </div>

            <!-- Compose from Factors -->
            <h3 class="header-with-color margin-top-30">‚ûï Calculadora: Componer desde Factores</h3>
            <div class="input-section">
                <div class="grid-autofit-120">
                    <div class="input-group">
                        <label for="factor1">Factor 1:</label>
                        <input type="number" id="factor1" placeholder="Ej: 2" min="2">
                    </div>
                    <div class="input-group">
                        <label for="factor2">Factor 2:</label>
                        <input type="number" id="factor2" placeholder="Ej: 2">
                    </div>
                    <div class="input-group">
                        <label for="factor3">Factor 3:</label>
                        <input type="number" id="factor3" placeholder="(opcional)">
                    </div>
                    <div class="input-group">
                        <label for="factor4">Factor 4:</label>
                        <input type="number" id="factor4" placeholder="(opcional)">
                    </div>
                </div>
                <button class="calc-button" onclick="composeFromFactors()">Multiplicar Factores</button>
            </div>
            <div id="compose-result" class="result-container"></div>
        </div>

        <!-- ENTRENAMIENTO TAB -->
        <div id="entrenamiento" class="content tab-content">
            <h2 class="section-title">üèÜ Entrenamiento: Practica Factorizaci√≥n Prima</h2>
            
            <div class="practice-area">
                <div id="score-container"></div>

                <h3 class="header-with-color" id="practice-question">Haz clic en "Nueva Pregunta" para empezar</h3>
                
                <div id="practice-visual" class="result-container"></div>

                <div class="input-section">
                    <div class="input-group">
                        <label for="practice-answer">Tu respuesta (factores separados por comas):</label>
                        <input type="text" id="practice-answer" placeholder="Ej: 2,2,3">
                    </div>
                    <button class="calc-button" id="check-button" onclick="checkAnswer()">‚úÖ Comprobar</button>
                    <button class="calc-button" onclick="generateQuestion()">üîÑ Nueva Pregunta</button>
                </div>
                <div class="result" id="practice-result"></div>
            </div>

            <div class="fun-facts">
                <h3>üí° Consejos para Practicar:</h3>
                <ul>
                    <li>Empieza siempre probando con 2 (el primo m√°s peque√±o)</li>
                    <li>Si el n√∫mero es impar, prueba con 3, 5, 7...</li>
                    <li>Escribe los factores separados por comas (Ej: 2,2,3)</li>
                    <li>El orden no importa: 2√ó3 = 3√ó2</li>
                    <li>¬°Cada respuesta correcta suma +10 puntos!</li>
                    <li>Respuestas incorrectas restan -5 puntos</li>
                </ul>
            </div>
        </div>

        <!-- EXAMEN FINAL TAB -->
        <div id="examen" class="content tab-content">
            <h2 class="section-title">üìù Examen Final de Factorizaci√≥n Prima</h2>
            
            <div class="explanation">
                <p>Completa este examen para demostrar tu dominio de la factorizaci√≥n prima.</p>
                <p><strong>Requisitos:</strong> 70% o m√°s para aprobar (14/20 respuestas correctas)</p>
                <p><strong>Recompensa:</strong> Obt√©n el trofeo "Maestro de los Primos" üèÜ</p>
            </div>

            <div id="exam-container">
                <button class="calc-button" onclick="startExam()">üöÄ Comenzar Examen</button>
            </div>

            <div id="exam-content" style="display: none;">
                <div id="exam-progress" class="margin-bottom-20"></div>
                <h3 id="exam-question" class="header-with-color"></h3>
                <div id="exam-visual" class="result-container"></div>
                <div class="input-section">
                    <div class="input-group">
                        <label for="exam-answer">Tu respuesta:</label>
                        <input type="text" id="exam-answer" placeholder="Ej: 2,2,3">
                    </div>
                    <button class="calc-button" onclick="submitExamAnswer()">‚û°Ô∏è Siguiente Pregunta</button>
                </div>
                <div id="exam-feedback" class="result-container"></div>
            </div>

            <div id="exam-results" style="display: none;">
                <div class="composition-box">
                    <h2 id="exam-title"></h2>
                    <div class="composition-equation" id="exam-score"></div>
                    <p id="exam-message"></p>
                    <div id="exam-trophy"></div>
                </div>
                <button class="calc-button" onclick="retakeExam()">üîÑ Reintentar Examen</button>
            </div>
        </div>
    </div>

    <script src="../../lib/storage.js"></script>
    <script src="../../lib/gamification.js"></script>
    <script src="../../lib/components.js"></script>

    <script>
        const MODULE_ID = 'factorizacion-prima';
        let currentQuestion = null;
        let questionAnswered = false;
        let examQuestions = [];
        let currentExamQuestion = 0;
        let examScore = 0;
        let examAnswers = [];

        function init() {
            const headerHtml = Components.createHeader(
                '‚≠ê ¬°Factorizaci√≥n Prima! ‚≠ê',
                'Descubre los bloques b√°sicos de los n√∫meros',
                '../index.html'
            );
            document.getElementById('header-container').innerHTML = headerHtml;

            const tabs = [
                { id: 'glosario', label: 'üìñ Glosario' },
                { id: 'simbolos', label: 'ÔøΩÔøΩ S√≠mbolos' },
                { id: 'introduccion', label: 'üìö Introducci√≥n' },
                { id: 'teoria', label: 'üßÆ Teor√≠a' },
                { id: 'entrenamiento', label: 'üèÜ Entrenamiento' },
                { id: 'examen', label: 'üìù Examen Final' }
            ];
            const tabsHtml = Components.createTabs(tabs, 'glosario');
            document.getElementById('tabs-container').innerHTML = tabsHtml;

            const scoreHtml = Components.createScoreDisplay();
            document.getElementById('score-container').innerHTML = scoreHtml;
            
            updateScoreDisplay();
            
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const button = this.closest('.input-section, .input-group')?.parentElement?.querySelector('.calc-button');
                        if (button && !button.disabled) button.click();
                    }
                });
            });
            
            Storage.updateStreak();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.tab-button').forEach(button => {
                const buttonText = button.textContent.toLowerCase();
                if (buttonText.includes(tabName) || 
                    (tabName === 'glosario' && buttonText.includes('glosario')) ||
                    (tabName === 'simbolos' && buttonText.includes('s√≠mbolos')) ||
                    (tabName === 'introduccion' && buttonText.includes('introducci√≥n')) ||
                    (tabName === 'teoria' && buttonText.includes('teor√≠a')) ||
                    (tabName === 'entrenamiento' && buttonText.includes('entrenamiento')) ||
                    (tabName === 'examen' && buttonText.includes('examen'))) {
                    button.classList.add('active');
                }
            });
        }

        function isPrime(n) {
            if (n < 2) return false;
            if (n === 2) return true;
            if (n % 2 === 0) return false;
            for (let i = 3; i <= Math.sqrt(n); i += 2) {
                if (n % i === 0) return false;
            }
            return true;
        }

        function getPrimeFactors(n) {
            const factors = [];
            let divisor = 2;
            
            while (n > 1) {
                while (n % divisor === 0) {
                    factors.push(divisor);
                    n = n / divisor;
                }
                divisor++;
                if (divisor * divisor > n && n > 1) {
                    factors.push(n);
                    break;
                }
            }
            
            return factors;
        }

        function testPrime() {
            const input = document.getElementById('prime-test-input');
            const num = parseInt(input.value);
            
            if (isNaN(num) || num < 2) {
                document.getElementById('prime-test-result').innerHTML = '<div class="result bg-warning-light">¬°Por favor, escribe un n√∫mero mayor que 1!</div>';
                return;
            }
            
            const prime = isPrime(num);
            const resultClass = prime ? 'bg-success-light' : 'bg-error-light';
            const resultText = prime ? `‚úì ${num} es un n√∫mero PRIMO` : `‚úó ${num} NO es primo`;
            
            let html = `<div class="result ${resultClass}">${resultText}</div>`;
            
            if (!prime) {
                const factors = getPrimeFactors(num);
                html += `<p class="text-center">Factores primos: <strong>${num} = ${factors.join(' √ó ')}</strong></p>`;
            }
            
            document.getElementById('prime-test-result').innerHTML = html;
        }

        function factorizeNumber() {
            const input = document.getElementById('factor-input');
            const num = parseInt(input.value);
            
            if (isNaN(num) || num < 2) {
                document.getElementById('factor-result').innerHTML = '<div class="result bg-warning-light">¬°Por favor, escribe un n√∫mero mayor que 1!</div>';
                return;
            }
            
            if (isPrime(num)) {
                document.getElementById('factor-result').innerHTML = `
                    <div class="factor-list">
                        <h3>${num} es un n√∫mero PRIMO</h3>
                        <p>Los n√∫meros primos solo se dividen por 1 y por s√≠ mismos.</p>
                        <div class="factor-display">${num} = ${num}</div>
                    </div>
                `;
                return;
            }
            
            const factors = getPrimeFactors(num);
            
            let html = '<div class="factor-list">';
            html += `<h3>Factorizaci√≥n Prima de ${num}</h3>`;
            html += `<div class="factor-display">${num} = ${factors.join(' √ó ')}</div>`;
            
            // Count occurrences for exponential notation
            const counts = {};
            factors.forEach(f => counts[f] = (counts[f] || 0) + 1);
            
            const exponential = Object.keys(counts)
                .map(f => counts[f] > 1 ? `${f}^${counts[f]}` : f)
                .join(' √ó ');
            
            html += `<p>Con exponentes: ${num} = ${exponential}</p>`;
            html += '</div>';
            
            document.getElementById('factor-result').innerHTML = html;
        }

        function composeFromFactors() {
            const f1 = parseInt(document.getElementById('factor1').value);
            const f2 = parseInt(document.getElementById('factor2').value);
            const f3 = parseInt(document.getElementById('factor3').value) || null;
            const f4 = parseInt(document.getElementById('factor4').value) || null;
            
            if (isNaN(f1) || isNaN(f2)) {
                document.getElementById('compose-result').innerHTML = '<div class="result bg-warning-light">¬°Por favor, escribe al menos 2 factores!</div>';
                return;
            }
            
            const factors = [f1, f2];
            if (f3) factors.push(f3);
            if (f4) factors.push(f4);
            
            const product = factors.reduce((a, b) => a * b, 1);
            
            let html = '<div class="composition-box">';
            html += `<div class="composition-equation">${factors.join(' √ó ')} = ${product}</div>`;
            html += '</div>';
            
            document.getElementById('compose-result').innerHTML = html;
        }

        function generateQuestion() {
            // Generate a random number between 4 and 100
            const num = Math.floor(Math.random() * 97) + 4;
            
            currentQuestion = {
                number: num,
                answer: getPrimeFactors(num)
            };
            
            document.getElementById('practice-question').textContent = `Factoriza el n√∫mero: ${num}`;
            document.getElementById('practice-visual').innerHTML = '';
            document.getElementById('practice-answer').value = '';
            document.getElementById('practice-result').textContent = '';
            document.getElementById('check-button').disabled = false;
            questionAnswered = false;
        }

        function checkAnswer() {
            if (questionAnswered || !currentQuestion) return;
            
            const userAnswer = document.getElementById('practice-answer').value.trim();
            
            if (!userAnswer) {
                document.getElementById('practice-result').innerHTML = '<div class="result bg-warning-light">¬°Por favor, escribe tu respuesta!</div>';
                return;
            }
            
            // Parse user's factors
            const userFactors = userAnswer.split(',').map(f => parseInt(f.trim())).filter(f => !isNaN(f)).sort((a, b) => a - b);
            const correctFactors = currentQuestion.answer.sort((a, b) => a - b);
            
            // Check if arrays are equal
            const isCorrect = JSON.stringify(userFactors) === JSON.stringify(correctFactors);
            
            if (isCorrect) {
                document.getElementById('practice-result').innerHTML = '<div class="result bg-success-light">‚úì ¬°Correcto! +10 puntos</div>';
                Storage.addPoints(10);
                Gamification.checkAchievements();
            } else {
                document.getElementById('practice-result').innerHTML = 
                    `<div class="result bg-error-light">‚úó Incorrecto. La respuesta correcta es: ${correctFactors.join(', ')} (-5 puntos)</div>`;
                Storage.addPoints(-5);
            }
            
            updateScoreDisplay();
            document.getElementById('check-button').disabled = true;
            questionAnswered = true;
        }

        function updateScoreDisplay() {
            const userData = Storage.getUserData();
            document.getElementById('user-points').textContent = userData.points;
            document.getElementById('user-level').textContent = Gamification.getLevel(userData.points);
        }

        // EXAM FUNCTIONS
        function generateExamQuestions() {
            const questions = [];
            const numbers = [];
            
            // Generate 20 unique numbers for factorization
            while (numbers.length < 20) {
                const num = Math.floor(Math.random() * 97) + 4;
                if (!numbers.includes(num)) {
                    numbers.push(num);
                }
            }
            
            numbers.forEach(num => {
                questions.push({
                    number: num,
                    answer: getPrimeFactors(num)
                });
            });
            
            return questions;
        }

        function startExam() {
            examQuestions = generateExamQuestions();
            currentExamQuestion = 0;
            examScore = 0;
            examAnswers = [];
            
            document.getElementById('exam-container').style.display = 'none';
            document.getElementById('exam-content').style.display = 'block';
            document.getElementById('exam-results').style.display = 'none';
            
            showExamQuestion();
        }

        function showExamQuestion() {
            if (currentExamQuestion >= examQuestions.length) {
                showExamResults();
                return;
            }
            
            const question = examQuestions[currentExamQuestion];
            const progress = `Pregunta ${currentExamQuestion + 1} de ${examQuestions.length}`;
            
            document.getElementById('exam-progress').innerHTML = `<p><strong>${progress}</strong></p>`;
            document.getElementById('exam-question').textContent = `Factoriza el n√∫mero: ${question.number}`;
            document.getElementById('exam-answer').value = '';
            document.getElementById('exam-feedback').innerHTML = '';
        }

        function submitExamAnswer() {
            const question = examQuestions[currentExamQuestion];
            const userAnswer = document.getElementById('exam-answer').value.trim();
            
            if (!userAnswer) {
                document.getElementById('exam-feedback').innerHTML = '<div class="result bg-warning-light">¬°Por favor, escribe tu respuesta!</div>';
                return;
            }
            
            // Parse user's factors
            const userFactors = userAnswer.split(',').map(f => parseInt(f.trim())).filter(f => !isNaN(f)).sort((a, b) => a - b);
            const correctFactors = question.answer.sort((a, b) => a - b);
            
            // Check if correct
            const isCorrect = JSON.stringify(userFactors) === JSON.stringify(correctFactors);
            
            examAnswers.push({
                question: question.number,
                userAnswer: userAnswer,
                correct: isCorrect
            });
            
            if (isCorrect) {
                examScore++;
            }
            
            currentExamQuestion++;
            showExamQuestion();
        }

        function showExamResults() {
            document.getElementById('exam-content').style.display = 'none';
            document.getElementById('exam-results').style.display = 'block';
            
            const percentage = (examScore / examQuestions.length) * 100;
            const passed = percentage >= 70;
            
            document.getElementById('exam-title').textContent = passed ? '¬°Felicitaciones! üéâ' : 'Sigue Practicando üìö';
            document.getElementById('exam-score').textContent = `${examScore} / ${examQuestions.length} (${percentage.toFixed(1)}%)`;
            document.getElementById('exam-message').textContent = passed ? 
                '¬°Has aprobado el examen de Factorizaci√≥n Prima!' : 
                'Necesitas 70% o m√°s para aprobar. ¬°Sigue practicando!';
            
            // Save exam result
            Storage.saveFinalExam(MODULE_ID, examScore, examQuestions.length, passed);
            
            // Award trophy if passed
            if (passed) {
                Storage.awardTrophy('factorizacion-prima');
                document.getElementById('exam-trophy').innerHTML = 
                    '<div class="result bg-success-light">üèÜ ¬°Has ganado el trofeo "Maestro de los Primos"!</div>';
                Gamification.showTrophyToast('Maestro de los Primos', '¬°Dominas la factorizaci√≥n prima!');
            } else {
                document.getElementById('exam-trophy').innerHTML = '';
            }
            
            Gamification.checkAchievements();
        }

        function retakeExam() {
            document.getElementById('exam-container').style.display = 'block';
            document.getElementById('exam-results').style.display = 'none';
        }

        window.onload = init;
    </script>
</body>
</html>
