<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬°Aprende a Leer el Reloj! - Conceptos de Tiempo</title>
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="../../css/core.css">
    <link rel="stylesheet" href="../../css/components.css">
    
    <style>
        /* Module-specific clock styles */
        .clock-container {
            width: 300px;
            height: 300px;
            margin: 30px auto;
            position: relative;
            background: white;
            border-radius: 50%;
            border: 8px solid var(--primary-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .clock-face {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .clock-hand {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform-origin: bottom center;
            background: var(--primary-color);
            border-radius: 10px 10px 0 0;
        }
        
        .hour-hand {
            width: 8px;
            height: 80px;
            margin-left: -4px;
            background: #333;
            z-index: 3;
        }
        
        .minute-hand {
            width: 6px;
            height: 110px;
            margin-left: -3px;
            background: var(--primary-color);
            z-index: 4;
        }
        
        .second-hand {
            width: 2px;
            height: 120px;
            margin-left: -1px;
            background: var(--accent-color);
            z-index: 5;
        }
        
        .clock-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 6;
        }
        
        .digital-display {
            background: #333;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 4em;
            font-weight: bold;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            margin: 30px auto;
        }
        
        .time-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .time-controls button {
            padding: 10px 20px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .time-controls button:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }
        
        .time-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .time-selector select {
            padding: 10px 15px;
            font-size: 1.1em;
            border: 2px solid var(--primary-color);
            border-radius: 10px;
            background: white;
            cursor: pointer;
        }
        
        .language-examples {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .language-example {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 10px;
        }
        
        .time-numeric {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .time-words {
            font-size: 1.2em;
            color: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="header-container"></div>
        <div id="tabs-container"></div>

        <!-- GLOSARIO TAB -->
        <div id="glosario" class="content tab-content active">
            <h2 class="section-title">üìñ Glosario de Lectura del Reloj</h2>
            
            <div class="explanation">
                <p>Aprende los t√©rminos clave relacionados con la lectura del reloj:</p>
            </div>

            <div class="glossary-grid">
                <div class="glossary-item">
                    <div class="glossary-term">üîµ Hora</div>
                    <div class="glossary-definition">
                        <strong>Definici√≥n:</strong> Unidad de tiempo que equivale a 60 minutos. El d√≠a tiene 24 horas.
                        <br><strong>Ejemplo:</strong> Son las 3 horas (03:00)
                    </div>
                </div>

                <div class="glossary-item">
                    <div class="glossary-term">üîµ Minuto</div>
                    <div class="glossary-definition">
                        <strong>Definici√≥n:</strong> Unidad de tiempo que equivale a 60 segundos. Una hora tiene 60 minutos.
                        <br><strong>Ejemplo:</strong> 30 minutos = media hora
                    </div>
                </div>

                <div class="glossary-item">
                    <div class="glossary-term">üîµ Segundo</div>
                    <div class="glossary-definition">
                        <strong>Definici√≥n:</strong> Unidad b√°sica de tiempo. Un minuto tiene 60 segundos.
                        <br><strong>Ejemplo:</strong> El segundero da una vuelta completa en 60 segundos
                    </div>
                </div>

                <div class="glossary-item">
                    <div class="glossary-term">üîµ Manecilla</div>
                    <div class="glossary-definition">
                        <strong>Definici√≥n:</strong> Aguja o puntero del reloj que indica horas, minutos o segundos.
                        <br><strong>Ejemplo:</strong> La manecilla corta marca las horas
                    </div>
                </div>

                <div class="glossary-item">
                    <div class="glossary-term">üîµ AM/PM</div>
                    <div class="glossary-definition">
                        <strong>Definici√≥n:</strong> AM = antes del mediod√≠a (00:00-11:59). PM = despu√©s del mediod√≠a (12:00-23:59).
                        <br><strong>Ejemplo:</strong> 9:00 AM = 09:00, 9:00 PM = 21:00
                    </div>
                </div>
            </div>
        </div>

        <!-- S√çMBOLOS TAB -->
        <div id="simbolos" class="content tab-content">
            <h2 class="section-title">üî£ S√≠mbolos del Reloj</h2>
            
            <div class="explanation">
                <p>Conoce los s√≠mbolos y notaciones usados para expresar el tiempo:</p>
            </div>

            <div class="symbols-grid">
                <div class="symbol-card">
                    <div class="symbol">üïê</div>
                    <div class="symbol-name">Reloj Anal√≥gico</div>
                    <div class="symbol-description">
                        Reloj con manecillas que se√±alan la hora en una esfera circular con n√∫meros del 1 al 12.
                    </div>
                    <div class="symbol-example">Ejemplo: üïê = 1:00</div>
                </div>

                <div class="symbol-card">
                    <div class="symbol">:</div>
                    <div class="symbol-name">Dos Puntos</div>
                    <div class="symbol-description">
                        Separa las horas de los minutos en formato digital. Tambi√©n puede separar los segundos.
                    </div>
                    <div class="symbol-example">Ejemplo: 14:30:45 (hora:minuto:segundo)</div>
                </div>

                <div class="symbol-card">
                    <div class="symbol">AM</div>
                    <div class="symbol-name">Ante Meridiem</div>
                    <div class="symbol-description">
                        Significa "antes del mediod√≠a" en lat√≠n. Indica las horas desde la medianoche hasta el mediod√≠a.
                    </div>
                    <div class="symbol-example">Ejemplo: 9:00 AM = 09:00 (ma√±ana)</div>
                </div>

                <div class="symbol-card">
                    <div class="symbol">PM</div>
                    <div class="symbol-name">Post Meridiem</div>
                    <div class="symbol-description">
                        Significa "despu√©s del mediod√≠a" en lat√≠n. Indica las horas desde el mediod√≠a hasta la medianoche.
                    </div>
                    <div class="symbol-example">Ejemplo: 3:00 PM = 15:00 (tarde)</div>
                </div>

                <div class="symbol-card">
                    <div class="symbol">24h</div>
                    <div class="symbol-name">Formato 24 horas</div>
                    <div class="symbol-description">
                        Sistema que cuenta las horas del 00:00 al 23:59, sin necesidad de AM/PM.
                    </div>
                    <div class="symbol-example">Ejemplo: 00:00 = medianoche, 12:00 = mediod√≠a</div>
                </div>
            </div>
        </div>

        <!-- INTRODUCCI√ìN TAB -->
        <div id="introduccion" class="content tab-content">
            <h2 class="section-title">üìö Introducci√≥n a la Lectura del Reloj</h2>
            
            <div class="explanation">
                <h3>¬øPor qu√© es importante leer el reloj?</h3>
                <p>La capacidad de leer el reloj es una habilidad fundamental en la vida diaria. Nos ayuda a organizar nuestro tiempo, cumplir con horarios y ser puntuales.</p>
            </div>

            <div class="real-world-examples">
                <h3>üåç Aplicaciones en la Vida Real</h3>
                
                <div class="example-card">
                    <div class="example-icon">üè´</div>
                    <div class="example-content">
                        <h4>En la Escuela</h4>
                        <p>Las clases comienzan a las 8:00 AM y terminan a las 2:00 PM. Cada clase dura 45 minutos con descansos de 10 minutos entre clases.</p>
                    </div>
                </div>

                <div class="example-card">
                    <div class="example-icon">üì∫</div>
                    <div class="example-content">
                        <h4>Programas de TV</h4>
                        <p>Tu programa favorito empieza a las 7:30 PM. Si son las 7:15 PM, ¬°tienes 15 minutos para preparar las palomitas!</p>
                    </div>
                </div>

                <div class="example-card">
                    <div class="example-icon">‚úàÔ∏è</div>
                    <div class="example-content">
                        <h4>Viajes y Transporte</h4>
                        <p>El tren sale a las 10:45 AM. Debes llegar 15 minutos antes, as√≠ que necesitas estar en la estaci√≥n a las 10:30 AM.</p>
                    </div>
                </div>

                <div class="example-card">
                    <div class="example-icon">‚öΩ</div>
                    <div class="example-content">
                        <h4>Deportes y Actividades</h4>
                        <p>El partido de f√∫tbol empieza a las 5:00 PM y dura 90 minutos (1 hora y 30 minutos). Terminar√° a las 6:30 PM.</p>
                    </div>
                </div>

                <div class="example-card">
                    <div class="example-icon">üåç</div>
                    <div class="example-content">
                        <h4>Comunicaci√≥n Internacional</h4>
                        <p>Tu amigo en Jap√≥n est√° 8 horas adelantado. Cuando aqu√≠ son las 2:00 PM, all√° son las 10:00 PM.</p>
                    </div>
                </div>
            </div>

            <div class="fun-facts">
                <h3>üí° Datos Curiosos</h3>
                <ul>
                    <li>Los primeros relojes mec√°nicos se inventaron en el siglo 14 en Europa</li>
                    <li>El reloj m√°s famoso del mundo es el Big Ben en Londres</li>
                    <li>Un d√≠a tiene exactamente 86,400 segundos</li>
                    <li>La Tierra rota 360 grados en 24 horas, por eso tenemos zonas horarias</li>
                    <li>En algunos lugares se usa el formato de 24 horas y en otros el de 12 horas con AM/PM</li>
                </ul>
            </div>
        </div>

        <!-- TEOR√çA TAB -->
        <div id="teoria" class="content tab-content">
            <h2 class="section-title">üéì Teor√≠a y Pr√°ctica del Reloj</h2>

            <div class="explanation">
                <h3>Reloj Anal√≥gico</h3>
                <p><strong>Manecilla corta (horaria):</strong> Se√±ala la hora (da 2 vueltas completas al d√≠a)</p>
                <p><strong>Manecilla larga (minutera):</strong> Se√±ala los minutos (da 1 vuelta completa cada hora)</p>
                <p><strong>Manecilla delgada (segundero):</strong> Se√±ala los segundos (da 1 vuelta completa cada minuto)</p>
            </div>

            <div class="clock-container">
                <div class="clock-face" id="analog-clock">
                    <div class="clock-hand hour-hand" id="hour-hand"></div>
                    <div class="clock-hand minute-hand" id="minute-hand"></div>
                    <div class="clock-hand second-hand" id="second-hand"></div>
                    <div class="clock-center"></div>
                </div>
            </div>

            <div class="time-selector">
                <label class="flex-align-gap">
                    <span>Hora:</span>
                    <select id="hour-select" onchange="updateAnalogClock()">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3" selected>3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                </label>
                <label class="flex-align-gap">
                    <span>Minutos:</span>
                    <select id="minute-select" onchange="updateAnalogClock()">
                        <option value="0">00</option>
                        <option value="5">05</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="20">20</option>
                        <option value="25">25</option>
                        <option value="30">30</option>
                        <option value="35">35</option>
                        <option value="40">40</option>
                        <option value="45">45</option>
                        <option value="50">50</option>
                        <option value="55">55</option>
                    </select>
                </label>
            </div>

            <div class="calculator">
                <h3>Reloj Digital</h3>
                <p>Los relojes digitales muestran el tiempo en formato <strong>HH:MM:SS</strong> (Hora:Minuto:Segundo)</p>
                
                <div class="digital-display" id="digital-clock">00:00:00</div>
                
                <div class="time-controls">
                    <button onclick="setCurrentTime()">‚è∞ Hora Actual</button>
                    <button onclick="setCustomTime(9, 0)">üåÖ 09:00 (Ma√±ana)</button>
                    <button onclick="setCustomTime(12, 0)">‚òÄÔ∏è 12:00 (Mediod√≠a)</button>
                    <button onclick="setCustomTime(18, 30)">üåÜ 18:30 (Tarde)</button>
                    <button onclick="setCustomTime(0, 0)">üåô 00:00 (Medianoche)</button>
                </div>
            </div>

            <div class="calculator">
                <h3>Lenguaje Natural - C√≥mo Decimos la Hora</h3>
                <div class="language-examples">
                    <div class="language-example">
                        <div class="time-numeric">03:00</div>
                        <div class="time-words">Las tres en punto</div>
                    </div>
                    <div class="language-example">
                        <div class="time-numeric">03:15</div>
                        <div class="time-words">Las tres y cuarto</div>
                    </div>
                    <div class="language-example">
                        <div class="time-numeric">03:30</div>
                        <div class="time-words">Las tres y media</div>
                    </div>
                    <div class="language-example">
                        <div class="time-numeric">03:45</div>
                        <div class="time-words">Las cuatro menos cuarto</div>
                    </div>
                    <div class="language-example">
                        <div class="time-numeric">12:00</div>
                        <div class="time-words">Mediod√≠a / Las doce</div>
                    </div>
                    <div class="language-example">
                        <div class="time-numeric">00:00</div>
                        <div class="time-words">Medianoche</div>
                    </div>
                </div>
            </div>

            <div class="fun-facts">
                <h3>üí° ¬øSab√≠as que...?</h3>
                <ul>
                    <li>La manecilla horaria da 2 vueltas completas al d√≠a (24 horas)</li>
                    <li>La manecilla minutera da 1 vuelta completa cada hora (60 minutos)</li>
                    <li>Cuando la minutera est√° en el 12, es "en punto"</li>
                    <li>Cuando est√° en el 6, es "y media"</li>
                    <li>Cada n√∫mero en el reloj anal√≥gico representa 5 minutos</li>
                </ul>
            </div>
        </div>

        <!-- ENTRENAMIENTO TAB -->
        <div id="entrenamiento" class="content tab-content">
            <h2 class="section-title">üèÜ Entrenamiento - ¬°Practica la Lectura del Reloj!</h2>
            
            <div class="practice-area">
                <div id="score-container"></div>

                <h3 class="header-with-color" id="practice-question">Haz clic en "Nueva Pregunta" para empezar</h3>
                
                <div id="practice-visual" class="min-height-200-flex-center"></div>

                <div class="input-section">
                    <div class="input-group">
                        <label for="practice-answer">Tu respuesta (HH:MM):</label>
                        <input type="text" id="practice-answer" placeholder="Ej: 03:45" onkeypress="handleEnterKey(event)">
                    </div>
                    <button class="calc-button" id="check-button" onclick="checkAnswer()">‚úÖ Comprobar</button>
                    <button class="calc-button" onclick="generateQuestion()">üîÑ Nueva Pregunta</button>
                    <div class="result" id="practice-result">¬°Genera una pregunta para empezar!</div>
                </div>
            </div>

            <div class="fun-facts">
                <h3>üí° Consejos:</h3>
                <ul>
                    <li>Recuerda: la manecilla corta es la hora, la larga los minutos</li>
                    <li>Cada n√∫mero en el reloj representa 5 minutos</li>
                    <li>Escribe la hora en formato 24 horas (Ej: 15:30 para las 3:30 PM)</li>
                    <li>Si la manecilla minutera est√° en el 12, los minutos son :00</li>
                    <li>Si la manecilla minutera est√° en el 6, los minutos son :30</li>
                </ul>
            </div>
        </div>

        <!-- EXAMEN FINAL TAB -->
        <div id="examen" class="content tab-content">
            <h2 class="section-title">üìù Examen Final de Lectura del Reloj</h2>
            
            <div class="explanation">
                <p>Completa este examen para demostrar tu dominio de la lectura del reloj.</p>
                <p><strong>Requisitos:</strong> 70% o m√°s para aprobar (14/20 respuestas correctas)</p>
                <p><strong>Recompensa:</strong> Obt√©n el trofeo "Maestro del Tiempo" üèÜ</p>
            </div>

            <div id="exam-container">
                <div id="exam-status" class="exam-status"></div>
                <div id="exam-content"></div>
                <div class="exam-controls">
                    <button class="calc-button" onclick="startExam()">üìù Comenzar Examen</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../lib/storage.js"></script>
    <script src="../../lib/gamification.js"></script>
    <script src="../../lib/components.js"></script>

    <script>
        const MODULE_ID = 'reloj';
        let currentQuestion = null;
        let questionAnswered = false;
        let clockInterval = null;

        // Exam variables
        let examQuestions = [];
        let currentExamQuestion = 0;
        let examAnswers = [];
        let examStarted = false;

        function init() {
            const headerHtml = Components.createHeader(
                'üïê ¬°Aprende a Leer el Reloj! üïê',
                'Domina el tiempo en todos sus formatos',
                '../index.html'
            );
            document.getElementById('header-container').innerHTML = headerHtml;

            const tabs = [
                { id: 'glosario', label: 'Glosario' },
                { id: 'simbolos', label: 'S√≠mbolos' },
                { id: 'introduccion', label: 'Introducci√≥n' },
                { id: 'teoria', label: 'Teor√≠a' },
                { id: 'entrenamiento', label: 'Entrenamiento' },
                { id: 'examen', label: 'Examen Final' }
            ];
            const tabsHtml = Components.createTabs(tabs, 'glosario');
            document.getElementById('tabs-container').innerHTML = tabsHtml;

            const scoreHtml = Components.createScoreDisplay();
            document.getElementById('score-container').innerHTML = scoreHtml;
            
            updateScoreDisplay();
            updateAnalogClock();
            updateDigitalClock();
            
            // Update clocks every second
            clockInterval = setInterval(() => {
                updateDigitalClock();
            }, 1000);
            
            Storage.updateStreak();
            checkExamStatus();
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            
            const tabMap = {
                'glosario': 'Glosario',
                'simbolos': 'S√≠mbolos',
                'introduccion': 'Introducci√≥n',
                'teoria': 'Teor√≠a',
                'entrenamiento': 'Entrenamiento',
                'examen': 'Examen Final'
            };
            
            document.querySelectorAll('.tab-button').forEach(button => {
                if (button.textContent.includes(tabMap[tabName])) {
                    button.classList.add('active');
                }
            });
        }

        function updateAnalogClock() {
            const hour = parseInt(document.getElementById('hour-select').value);
            const minute = parseInt(document.getElementById('minute-select').value);
            
            const hourHand = document.getElementById('hour-hand');
            const minuteHand = document.getElementById('minute-hand');
            const secondHand = document.getElementById('second-hand');
            
            const hourDegrees = (hour % 12) * 30 + (minute / 60) * 30;
            const minuteDegrees = minute * 6;
            const secondDegrees = 0;
            
            hourHand.style.transform = `rotate(${hourDegrees}deg)`;
            minuteHand.style.transform = `rotate(${minuteDegrees}deg)`;
            secondHand.style.transform = `rotate(${secondDegrees}deg)`;
        }

        function updateDigitalClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            document.getElementById('digital-clock').textContent = `${hours}:${minutes}:${seconds}`;
        }

        function setCurrentTime() {
            updateDigitalClock();
        }

        function setCustomTime(hours, minutes) {
            const h = hours.toString().padStart(2, '0');
            const m = minutes.toString().padStart(2, '0');
            document.getElementById('digital-clock').textContent = `${h}:${m}:00`;
        }

        function generateQuestion() {
            const hour = Math.floor(Math.random() * 12) + 1;
            const minute = [0, 15, 30, 45][Math.floor(Math.random() * 4)];
            
            currentQuestion = { hour, minute };
            questionAnswered = false;
            
            document.getElementById('practice-question').textContent = 'Lee la hora del reloj:';
            
            // Create a practice clock
            const hourDegrees = (hour % 12) * 30 + (minute / 60) * 30;
            const minuteDegrees = minute * 6;
            
            document.getElementById('practice-visual').innerHTML = `
                <div class="clock-container" style="width: 200px; height: 200px;">
                    <div class="clock-face">
                        <div class="clock-hand hour-hand" style="transform: rotate(${hourDegrees}deg); width: 6px; height: 60px; margin-left: -3px;"></div>
                        <div class="clock-hand minute-hand" style="transform: rotate(${minuteDegrees}deg); width: 4px; height: 80px; margin-left: -2px;"></div>
                        <div class="clock-center" style="width: 12px; height: 12px;"></div>
                    </div>
                </div>
            `;
            
            document.getElementById('practice-answer').value = '';
            document.getElementById('practice-result').textContent = '¬°Escribe la hora en formato HH:MM!';
            document.getElementById('practice-result').style.background = 'rgba(255, 255, 255, 0.9)';
            
            const checkButton = document.getElementById('check-button');
            checkButton.disabled = false;
            checkButton.textContent = '‚úÖ Comprobar';
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }

        function checkAnswer() {
            const userAnswer = document.getElementById('practice-answer').value.trim();
            const result = document.getElementById('practice-result');
            
            if (!currentQuestion || questionAnswered) return;
            
            if (!userAnswer.match(/^\d{1,2}:\d{2}$/)) {
                result.textContent = '¬°Por favor, escribe la hora en formato HH:MM (ej: 03:30)!';
                result.style.background = 'rgba(255, 107, 107, 0.3)';
                return;
            }
            
            const [userHour, userMinute] = userAnswer.split(':').map(n => parseInt(n));
            const correctHour = currentQuestion.hour.toString().padStart(2, '0');
            const correctMinute = currentQuestion.minute.toString().padStart(2, '0');
            const correctAnswer = `${correctHour}:${correctMinute}`;
            
            questionAnswered = true;
            const checkButton = document.getElementById('check-button');
            checkButton.disabled = true;
            checkButton.textContent = '‚úÖ Respondido';
            
            if (userHour === currentQuestion.hour && userMinute === currentQuestion.minute) {
                Gamification.addPoints(10, MODULE_ID);
                result.innerHTML = `<div class="text-dark">¬°Correcto! üéâ<br>Son las <strong>${correctAnswer}</strong><br><small>+10 puntos</small></div>`;
                result.style.background = 'rgba(78, 205, 196, 0.3)';
            } else {
                Gamification.subtractPoints(5, MODULE_ID);
                result.innerHTML = `<div class="text-dark">¬°Intenta de nuevo! üòä<br>La hora correcta es <strong>${correctAnswer}</strong><br><small>-5 puntos</small></div>`;
                result.style.background = 'rgba(255, 107, 107, 0.3)';
            }
            
            updateScoreDisplay();
        }

        function updateScoreDisplay() {
            document.getElementById('score').textContent = Storage.getTotalPoints();
            document.getElementById('level').textContent = Gamification.getCurrentLevel().name;
        }

        // ============= EXAMEN FINAL =============
        
        function generateExamQuestions() {
            const questions = [];
            const usedTimes = new Set();
            
            // Generate 20 unique questions
            while (questions.length < 20) {
                const hour = Math.floor(Math.random() * 24);
                const minute = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55][Math.floor(Math.random() * 12)];
                const timeKey = `${hour}:${minute}`;
                
                if (!usedTimes.has(timeKey)) {
                    usedTimes.add(timeKey);
                    questions.push({
                        hour: hour,
                        minute: minute,
                        correctAnswer: `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`
                    });
                }
            }
            
            return questions;
        }

        function startExam() {
            examQuestions = generateExamQuestions();
            currentExamQuestion = 0;
            examAnswers = [];
            examStarted = true;
            
            showExamQuestion();
        }

        function showExamQuestion() {
            if (currentExamQuestion >= examQuestions.length) {
                finishExam();
                return;
            }
            
            const question = examQuestions[currentExamQuestion];
            const hourDegrees = (question.hour % 12) * 30 + (question.minute / 60) * 30;
            const minuteDegrees = question.minute * 6;
            
            document.getElementById('exam-status').innerHTML = `
                <p><strong>Pregunta ${currentExamQuestion + 1} de ${examQuestions.length}</strong></p>
                <p>Lee la hora que muestra el reloj y escr√≠bela en formato 24 horas (HH:MM):</p>
            `;
            
            document.getElementById('exam-content').innerHTML = `
                <div class="clock-container" style="width: 200px; height: 200px; margin: 20px auto;">
                    <div class="clock-face">
                        <div class="clock-hand hour-hand" style="transform: rotate(${hourDegrees}deg); width: 6px; height: 60px; margin-left: -3px;"></div>
                        <div class="clock-hand minute-hand" style="transform: rotate(${minuteDegrees}deg); width: 4px; height: 80px; margin-left: -2px;"></div>
                        <div class="clock-center" style="width: 12px; height: 12px;"></div>
                    </div>
                </div>
                <div class="input-section">
                    <div class="input-group">
                        <label for="exam-answer">Tu respuesta (HH:MM):</label>
                        <input type="text" id="exam-answer" placeholder="Ej: 14:30" onkeypress="handleExamEnter(event)" autofocus>
                    </div>
                </div>
            `;
            
            document.querySelector('.exam-controls').innerHTML = `
                <button class="calc-button" onclick="submitExamAnswer()">‚û°Ô∏è Siguiente</button>
            `;
        }

        function handleExamEnter(event) {
            if (event.key === 'Enter') {
                submitExamAnswer();
            }
        }

        function submitExamAnswer() {
            const userAnswer = document.getElementById('exam-answer').value.trim();
            
            if (!userAnswer.match(/^\d{1,2}:\d{2}$/)) {
                alert('Por favor, escribe la hora en formato HH:MM (ej: 14:30)');
                return;
            }
            
            const question = examQuestions[currentExamQuestion];
            const isCorrect = userAnswer === question.correctAnswer;
            
            examAnswers.push({
                question: question,
                userAnswer: userAnswer,
                correct: isCorrect
            });
            
            currentExamQuestion++;
            showExamQuestion();
        }

        function finishExam() {
            const correctCount = examAnswers.filter(a => a.correct).length;
            const totalQuestions = examQuestions.length;
            const percentage = (correctCount / totalQuestions) * 100;
            const passed = percentage >= 70;
            
            // Save exam result
            Storage.saveFinalTestResults(MODULE_ID, correctCount, totalQuestions, passed);
            
            let resultHTML = `
                <div class="exam-results">
                    <h3>${passed ? 'üéâ ¬°Felicitaciones!' : 'üìö Sigue Practicando'}</h3>
                    <p><strong>Resultado:</strong> ${correctCount} de ${totalQuestions} correctas (${percentage.toFixed(1)}%)</p>
                    <p><strong>Estado:</strong> ${passed ? '‚úÖ APROBADO' : '‚ùå NO APROBADO'}</p>
                    ${passed ? '<p><strong>üèÜ ¬°Has obtenido el trofeo "Maestro del Tiempo"!</strong></p>' : '<p>Necesitas 70% o m√°s para aprobar (14/20 correctas)</p>'}
                </div>
                
                <h4>Resumen de Respuestas:</h4>
                <div class="exam-summary">
            `;
            
            examAnswers.forEach((answer, index) => {
                const icon = answer.correct ? '‚úÖ' : '‚ùå';
                resultHTML += `
                    <div class="exam-answer ${answer.correct ? 'correct' : 'incorrect'}">
                        <strong>${icon} Pregunta ${index + 1}:</strong> 
                        ${answer.question.correctAnswer}
                        ${!answer.correct ? `<br><small>Tu respuesta: ${answer.userAnswer}</small>` : ''}
                    </div>
                `;
            });
            
            resultHTML += `</div>`;
            
            document.getElementById('exam-status').innerHTML = '';
            document.getElementById('exam-content').innerHTML = resultHTML;
            document.querySelector('.exam-controls').innerHTML = `
                <button class="calc-button" onclick="startExam()">üîÑ Intentar de Nuevo</button>
            `;
            
            if (passed) {
                Storage.awardTrophy('maestro_del_tiempo');
                Gamification.showTrophyToast('¬°Has dominado la lectura del reloj!', 'Maestro del Tiempo');
            }
            
            examStarted = false;
        }

        function checkExamStatus() {
            const moduleData = Storage.getModuleData(MODULE_ID);
            
            if (moduleData && moduleData.finalTest && moduleData.finalTest.passed) {
                document.getElementById('exam-status').innerHTML = `
                    <div class="exam-completed">
                        <h3>‚úÖ Examen Completado</h3>
                        <p>Puntuaci√≥n: ${moduleData.finalTest.score}/${moduleData.finalTest.totalQuestions} (${((moduleData.finalTest.score/moduleData.finalTest.totalQuestions)*100).toFixed(1)}%)</p>
                        <p>Estado: APROBADO üèÜ</p>
                        <p><em>Puedes volver a realizar el examen para mejorar tu puntuaci√≥n.</em></p>
                    </div>
                `;
            }
        }

        init();
    </script>
</body>
</html>
