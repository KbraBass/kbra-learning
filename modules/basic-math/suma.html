<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬°Aprende a Sumar! - Suma Divertida</title>
    
    <!-- Shared CSS -->
    <link rel="stylesheet" href="../../css/core.css">
    <link rel="stylesheet" href="../../css/components.css">
    
    <style>
        /* Module-specific theme override */
        .input-section {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header generated by Components.js -->
        <div id="header-container"></div>

        <!-- Tabs generated by Components.js -->
        <div id="tabs-container"></div>

        <!-- Tab Content: B√°sica -->
        <div class="content">
            <div class="tab-content active" id="basica">
                <div class="input-section">
                    <h2>üî¢ Calculadora de Suma</h2>
                    <div class="input-group">
                        <label for="sum1">Primer n√∫mero:</label>
                        <input type="number" id="sum1" placeholder="Ejemplo: 5" min="0">
                    </div>
                    <div class="input-group">
                        <label for="sum2">Segundo n√∫mero:</label>
                        <input type="number" id="sum2" placeholder="Ejemplo: 3" min="0">
                    </div>
                    <button class="calc-button" onclick="add()">‚ûï Sumar</button>
                    <div class="result" id="sum-result">¬°Escribe dos n√∫meros y s√∫malos!</div>
                </div>

                <div id="visual-sum"></div>

                <div class="explanation">
                    <h3>¬øQu√© es sumar?</h3>
                    <p>Sumar es juntar dos o m√°s grupos de cosas para saber cu√°ntas hay en total. 
                    Por ejemplo, si tienes 3 manzanas y tu amigo te da 2 m√°s, ahora tienes 5 manzanas.</p>
                </div>

                <div class="fun-facts">
                    <h3>üí° Datos Curiosos:</h3>
                    <ul>
                        <li>El s√≠mbolo "+" se usa desde hace m√°s de 500 a√±os</li>
                        <li>Puedes sumar en cualquier orden: 3 + 5 = 5 + 3</li>
                        <li>Sumar 0 a cualquier n√∫mero no lo cambia</li>
                        <li>Los dedos de tus manos te ayudan a contar hasta 10</li>
                    </ul>
                </div>
            </div>

            <!-- Tab Content: Con Llevadas -->
            <div class="tab-content" id="llevando">
                <div class="input-section">
                    <h2>üöÄ Suma con Llevadas</h2>
                    <p>Cuando los n√∫meros son m√°s grandes, a veces necesitamos "llevarnos" n√∫meros a la siguiente columna.</p>
                    
                    <div class="input-group">
                        <label for="carry1">Primer n√∫mero:</label>
                        <input type="number" id="carry1" placeholder="Ejemplo: 27" min="0">
                    </div>
                    <div class="input-group">
                        <label for="carry2">Segundo n√∫mero:</label>
                        <input type="number" id="carry2" placeholder="Ejemplo: 38" min="0">
                    </div>
                    <button class="calc-button" onclick="addWithCarry()">‚ûï Sumar con Explicaci√≥n</button>
                    <div class="result" id="carry-result">¬°Escribe dos n√∫meros!</div>
                </div>

                <div class="explanation" id="carry-explanation">
                    <h3>üìù Explicaci√≥n paso a paso:</h3>
                    <p>La explicaci√≥n aparecer√° aqu√≠ cuando sumes dos n√∫meros.</p>
                </div>

                <div class="fun-facts">
                    <h3>üí° Consejos:</h3>
                    <ul>
                        <li>Siempre empieza sumando por las unidades (el lado derecho)</li>
                        <li>Si la suma de las unidades es 10 o m√°s, "llevas" 1 a las decenas</li>
                        <li>Practica con n√∫meros peque√±os primero</li>
                        <li>¬°No te preocupes si te equivocas, es parte del aprendizaje!</li>
                    </ul>
                </div>
            </div>

            <!-- Tab Content: Pr√°ctica -->
            <div class="tab-content" id="practica">
                <div id="score-container"></div>

                <div class="practice-area">
                    <h2 id="practice-question">¬øCu√°nto es 5 + 3?</h2>
                    <div class="input-group">
                        <input type="number" id="practice-answer" placeholder="Tu respuesta..." class="practice-input">
                    </div>
                    <button class="calc-button" id="check-button" onclick="checkAnswer()">‚úÖ Comprobar</button>
                    <button class="calc-button" onclick="generateQuestion()">üîÑ Nueva Pregunta</button>
                    <div class="result" id="practice-result">¬°Escribe tu respuesta!</div>
                </div>

                <div class="fun-facts">
                    <h3>üí° Consejos:</h3>
                    <ul>
                        <li>Usa tus dedos para contar cuando empieces</li>
                        <li>El orden no importa: 5 + 3 = 3 + 5 = 8</li>
                        <li>Practica con n√∫meros peque√±os primero, ¬°luego sube!</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Shared JavaScript Libraries -->
    <script src="../../lib/storage.js"></script>
    <script src="../../lib/gamification.js"></script>
    <script src="../../lib/components.js"></script>

    <!-- Module-specific JavaScript -->
    <script>
        const MODULE_ID = 'suma';
        let score = 0;
        let currentQuestion = null;
        let questionAnswered = false;
        let startTime = Date.now();

        // Initialize module
        function init() {
            // Render header
            document.getElementById('header-container').innerHTML = Components.createHeader({
                title: '¬°Aprende a Sumar!',
                subtitle: 'Descubre la diversi√≥n de juntar n√∫meros',
                icon: '‚ûï',
                backLink: '../index.html'
            });

            // Render tabs
            const tabs = [
                { id: 'basica', label: 'Suma B√°sica' },
                { id: 'llevando', label: 'Suma con Llevadas' },
                { id: 'practica', label: '¬°Pr√°ctica!' }
            ];
            document.getElementById('tabs-container').innerHTML = Components.createTabs(tabs);

            // Render score display
            const moduleData = Storage.getModuleData(MODULE_ID);
            const currentScore = moduleData ? moduleData.score : 0;
            const currentLevel = Storage.getCurrentLevel();
            
            document.getElementById('score-container').innerHTML = Components.createScoreDisplay(currentScore, currentLevel);

            // Update streak
            Storage.updateStreak();

            // Generate first practice question
            generateQuestion();
        }

        // Tab switching function
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Basic addition
        function add() {
            const num1 = parseInt(document.getElementById('sum1').value);
            const num2 = parseInt(document.getElementById('sum2').value);
            const result = document.getElementById('sum-result');
            
            if (isNaN(num1) || isNaN(num2) || num1 < 0 || num2 < 0) {
                result.textContent = '¬°Por favor, escribe n√∫meros v√°lidos!';
                result.style.background = 'rgba(255, 107, 107, 0.3)';
                return;
            }
            
            const sum = num1 + num2;
            
            result.innerHTML = `
                <div>
                    ${num1} + ${num2} = ${sum} üéâ<br>
                    <small class="fs-08em">¬°Juntamos ${num1} y ${num2}!</small>
                </div>
            `;
            result.style.background = 'rgba(78, 205, 196, 0.3)';
            
            generateVisualSum(num1, num2);
        }

        // Generate visual representation
        function generateVisualSum(num1, num2) {
            const container = document.getElementById('visual-sum');
            
            if (num1 + num2 > 40) {
                container.innerHTML = `<p class="number-too-large">¬°El resultado es ${num1 + num2}! Es demasiado grande para mostrarlo visualmente, pero ¬°lo calculaste bien!</p>`;
                return;
            }
            
            let html = '<div class="visual-demo">';
            html += Components.createNumberBlocks(num1, 'üîµ', 40);
            html += '<div style="font-size: 2em; color: #333;">+</div>';
            html += Components.createNumberBlocks(num2, 'üü¢', 40);
            html += '<div style="font-size: 2em; color: #333;">=</div>';
            html += `<div style="font-size: 3em; color: #f5576c; font-weight: bold;">${num1 + num2}</div>`;
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Addition with carry
        function addWithCarry() {
            const num1 = parseInt(document.getElementById('carry1').value);
            const num2 = parseInt(document.getElementById('carry2').value);
            const result = document.getElementById('carry-result');
            
            if (isNaN(num1) || isNaN(num2) || num1 < 0 || num2 < 0) {
                result.textContent = '¬°Por favor, escribe n√∫meros v√°lidos!';
                result.style.background = 'rgba(255, 107, 107, 0.3)';
                return;
            }
            
            const sum = num1 + num2;
            
            result.innerHTML = `
                <div>
                    ${num1} + ${num2} = ${sum} üéâ<br>
                    <small class="fs-08em">¬°Mira abajo c√≥mo se hace paso a paso!</small>
                </div>
            `;
            result.style.background = 'rgba(78, 205, 196, 0.3)';
            
            explainCarry(num1, num2, sum);
        }

        // Explain carry-over
        function explainCarry(num1, num2, sum) {
            const container = document.getElementById('carry-explanation');
            
            const units1 = num1 % 10;
            const tens1 = Math.floor(num1 / 10);
            const units2 = num2 % 10;
            const tens2 = Math.floor(num2 / 10);
            
            const unitsSum = units1 + units2;
            const carry = Math.floor(unitsSum / 10);
            const finalUnits = unitsSum % 10;
            const tensSum = tens1 + tens2 + carry;
            
            let html = '<h3 style="color: #f5576c; margin-bottom: 15px;">Paso a paso:</h3>';
            html += '<div style="font-size: 1.2em; line-height: 2;">';
            html += `<p>1Ô∏è‚É£ <strong>Unidades:</strong> ${units1} + ${units2} = ${unitsSum}`;
            if (carry > 0) {
                html += ` ‚Üí Escribimos <strong>${finalUnits}</strong> y llevamos <strong>${carry}</strong>`;
            }
            html += '</p>';
            html += `<p>2Ô∏è‚É£ <strong>Decenas:</strong> ${tens1} + ${tens2}`;
            if (carry > 0) {
                html += ` + ${carry} (que llev√°bamos)`;
            }
            html += ` = ${tensSum}</p>`;
            html += `<p>3Ô∏è‚É£ <strong>Resultado final:</strong> ${tensSum}${finalUnits} = ${sum} ‚ú®</p>`;
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Generate practice question
        function generateQuestion() {
            const difficulty = Math.random();
            let num1, num2;
            
            if (difficulty < 0.4) {
                num1 = Math.floor(Math.random() * 9) + 1;
                num2 = Math.floor(Math.random() * 9) + 1;
            } else if (difficulty < 0.7) {
                num1 = Math.floor(Math.random() * 40) + 10;
                num2 = Math.floor(Math.random() * 40) + 10;
            } else {
                num1 = Math.floor(Math.random() * 49) + 50;
                num2 = Math.floor(Math.random() * 49) + 50;
            }
            
            currentQuestion = {
                num1: num1,
                num2: num2,
                answer: num1 + num2
            };
            
            document.getElementById('practice-question').textContent = `${num1} + ${num2} = ?`;
            document.getElementById('practice-answer').value = '';
            document.getElementById('practice-result').textContent = '¬°Escribe tu respuesta!';
            document.getElementById('practice-result').style.background = 'rgba(255, 255, 255, 0.9)';
            questionAnswered = false;
            
            const checkButton = document.getElementById('check-button');
            checkButton.disabled = false;
            checkButton.textContent = '‚úÖ Comprobar';
        }

        // Check answer
        function checkAnswer() {
            const userAnswer = parseInt(document.getElementById('practice-answer').value);
            const result = document.getElementById('practice-result');
            
            if (!currentQuestion || questionAnswered) {
                return;
            }
            
            if (isNaN(userAnswer)) {
                result.textContent = '¬°Por favor, escribe un n√∫mero!';
                result.style.background = 'rgba(255, 107, 107, 0.3)';
                return;
            }
            
            questionAnswered = true;
            const checkButton = document.getElementById('check-button');
            checkButton.disabled = true;
            checkButton.textContent = '‚úÖ Respondido';
            
            if (userAnswer === currentQuestion.answer) {
                // Correct answer
                const points = Gamification.addPoints(10, MODULE_ID);
                score += 10;
                
                result.innerHTML = `
                    <div class="color-333">
                        ¬°Correcto! üéâ<br>
                        ${currentQuestion.num1} + ${currentQuestion.num2} = ${currentQuestion.answer}<br>
                        <small>+10 puntos (Total: ${points})</small>
                    </div>
                `;
                result.style.background = 'rgba(78, 205, 196, 0.3)';
            } else {
                // Incorrect answer
                const points = Gamification.subtractPoints(5, MODULE_ID);
                score = Math.max(0, score - 5);
                
                result.innerHTML = `
                    <div class="color-333">
                        ¬°Intenta de nuevo! üòä<br>
                        ${currentQuestion.num1} + ${currentQuestion.num2} = ${currentQuestion.answer}<br>
                        <small>-5 puntos. ¬°Sigue practicando! (Total: ${points})</small>
                    </div>
                `;
                result.style.background = 'rgba(255, 107, 107, 0.3)';
            }
            
            updateScoreDisplay();
        }

        // Update score display
        function updateScoreDisplay() {
            const levelInfo = Gamification.getCurrentLevel();
            document.getElementById('score').textContent = levelInfo.totalPoints;
            document.getElementById('level').textContent = levelInfo.current;
        }

        // Handle Enter key
        document.addEventListener('DOMContentLoaded', function() {
            init();
            
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const section = this.closest('.input-section, .practice-area');
                        const button = section?.querySelector('button:not(:disabled)');
                        if (button) {
                            button.click();
                        }
                    }
                });
            });
        });

        // Track time spent
        window.addEventListener('beforeunload', function() {
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            Storage.addTimeSpent(timeSpent);
        });
    </script>
</body>
</html>
